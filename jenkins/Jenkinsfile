pipeline {
    agent any

    environment {
        WEBEX_BOT_TOKEN = credentials('OWE2MjNjYzktMmRiNS00MzI1LTlkZTItNjViZmNhMjFhM2JmZTAwNDIzZWEtYzk3_P0A1_13494cac-24b4-4f89-8247-193cc92a7636')
        WEBEX_ROOM_ID   = credentials('Y2lzY29zcGFyazovL3VybjpURUFNOnVzLXdlc3QtMl9yL1JPT00vMjExMTI5OTAtY2IxNS0xMWYwLWFkMjctMmY0ZWY5NzZiMjIy')
        DOCKER_IMAGE    = 'onboarding-automation:latest'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                script {
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1',
                        returnStdout: true
                    ).trim()
                    env.CHANGED_FILES = changes
                    echo "Changed files: ${changes}"
                }
            }
        }

        stage('Validate Employee Data') {
            steps {
                script {
                    def employeeFile = sh(
                        script: '''
                            echo "${CHANGED_FILES}" | grep -E "employees/(onboarding|offboarding)/" | head -1 || true
                        ''',
                        returnStdout: true
                    ).trim()

                    if (!employeeFile) {
                        echo "No employee files changed. Skipping pipeline."
                        currentBuild.result = 'NOT_BUILT'
                        return
                    }

                    env.EMPLOYEE_FILE = employeeFile
                    echo "Processing employee YAML: ${employeeFile}"

                    sh "python3 scripts/validate_employee.py ${employeeFile}"
                }
            }
        }

        stage('Build Docker Environment') {
            steps {
                sh "docker build -t ${DOCKER_IMAGE} -f docker/Dockerfile ."
            }
        }

        stage('Start LDAP Server') {
            steps {
                script {
                    def ldapExists = sh(
                        script: 'docker ps -a --filter name=ldap-server --format "{{.Names}}"',
                        returnStdout: true
                    ).trim()

                    if (!ldapExists) {
                        sh '''
                            docker run -d \
                                --name ldap-server \
                                -p 389:389 \
                                -e LDAP_ORGANISATION="Company Inc" \
                                -e LDAP_DOMAIN="company.com" \
                                -e LDAP_ADMIN_PASSWORD="admin123" \
                                osixia/openldap:latest

                            sleep 10
                        '''
                    } else {
                        sh "docker start ldap-server || true"
                    }
                }
            }
        }

        stage('Run Automation') {
            steps {
                script {
                    // Onboard = employee_file path contains "onboarding"
                    def action = env.EMPLOYEE_FILE.contains('onboarding') ? 'onboard' : 'offboard'

                    sh """
                        docker run --rm \
                            --network host \
                            -v \$(pwd):/automation \
                            -e WEBEX_BOT_TOKEN=${WEBEX_BOT_TOKEN} \
                            -e WEBEX_ROOM_ID=${WEBEX_ROOM_ID} \
                            -e ANSIBLE_HOST_KEY_CHECKING=False \
                            ${DOCKER_IMAGE} \
                            ansible-playbook \
                                -i /automation/ansible/inventory/hosts.ini \
                                /automation/ansible/playbooks/${action}.yml \
                                -e employee_file=/automation/${EMPLOYEE_FILE} \
                                -v
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                // Only run tests if tests exist
                script {
                    sh """
                        if [ -d tests ]; then
                            python3 -m pytest tests/ -v --junitxml=test-results.xml
                        else
                            echo 'No tests directory, skipping pytest.'
                        fi
                    """
                }
            }
        }

        stage('Verify LDAP Connectivity') {
            steps {
                sh '''
                    docker run --rm \
                        --network host \
                        osixia/openldap:latest \
                        ldapsearch -x -H ldap://localhost:389 \
                        -D "cn=admin,dc=company,dc=com" \
                        -w admin123 \
                        -b "dc=company,dc=com" \
                        "(objectClass=*)"
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline cleanup complete."
        }
        failure {
            echo "Pipeline failed!"
        }
        success {
            echo "Build succeeded!"
        }
    }
}